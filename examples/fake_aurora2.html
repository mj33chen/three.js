<!doctype html>
<html lang="en">
	<head>
		<title>Aurora using Simplex Noise</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">

	</head>
	<body>
		<style>
		 body {
			background-color: lightblue;
		}
		</style>
		<script src="../build/Three.js"></script>
		<script src="js/SimplexNoise.js"></script>

		<script>
		var context;
			/* CPU Based method */
			function createCloudTexture(width, height) {
				var canvas = document.createElement("canvas");
				canvas.width = width;
				canvas.height = height;
				
				//var 
				context = canvas.getContext('2d');
				
				//var image = context.createImageData( width, height );
				
				
				
				
				var simplex = new SimplexNoise();
				
				
				
				
				document.body.appendChild(canvas);
				
				this.redraw = function() {
					var now = Date.now();
					var time = now / 8000;
					
					context.clearRect(0, 0, width, height);
					//context.fillStyle = 'white';
					//context.fillRect(0, 0, width, height);
					
					
					//var gradient = context.createLinearGradient( 0,0, width, height );
					var gradient = context.createLinearGradient( 0,0, width, height );

					gradient.addColorStop( 0, 'rgba(255,255,255,1)' );
					gradient.addColorStop( (Math.sin(time)+1) * 0.5 *0.2, 'rgba(100,0,0,1)' );
					gradient.addColorStop( (Math.cos(time)+1) * 0.5 * 0.2 + 0.4 , 'rgba(0,200,0,1)' ); // 0.6
					gradient.addColorStop( 1, 'rgba(0,0,200,1)' );

					context.fillStyle = gradient;
					
					//context.fillStyle = 'blue'; //lightblue
					context.fillRect(0,0, width, height);
					// context.fillRect(0,height/2, width, height);
					
					var image = context.getImageData( 0, 0, width, height );
					var image2 = context.getImageData( 0, 0, width, height );
					
					var imageData = image.data;
					var imageData2 = image2.data;
					
					
					var w,h, n;
					
					// settings
					var octaves = 1;
					var cloudSharpness = 0.9; // 0 for fuzzy clouds, 1 for abruptly ending clouds (0.6-0.9 recommended)
					var cloudColor = 0.8; // 0 no clouds, 1 full clouds (0.6-1)
				
					var scaleX = 4, scaleY = 0.25;
				
					
					
					var w,h, n;
					
					
					
					for ( var i = 0, j = 0, l = imageData.length; i < l; i += 4, j ++  ) {
					
						h = Math.floor( j/width );
						w = j % width;
					
						n = 0;
						var frequency = 1;
						var persistance = 0.5;
						var amptitude ;
					
						for (var oi=0; oi < octaves; oi++) {
							frequency *= 2;
							amptitude =  Math.pow(persistance, oi);
						
							n += simplex.noise3d(w/width * frequency * scaleX, h/height* frequency * scaleY, time)  * amptitude ;
						}

					
						var m = n;
						var factor = n* 0.5 + 0.5; // + 1 ) * 0.5
						n = Math.floor( factor * 255); //Math.floor
					
						// Light green / light blue
						
						// function displace(m, a) {
						// 	return imageData2[ a + Math.floor(m * height * 0.25) * 4 * width  ];
						// }
						// 
						// // Displacement Map?
						// // if (imageData[ i + 3 ]>0) {
						// 	imageData[ i ] = displace( m, i);
						// 	imageData[ i + 1 ] = displace( m, i+1 );
						// 	imageData[ i + 2 ] = displace( m, i+2 );
						// 	imageData[ i + 3 ] = 255;
						// // }

						
						// n += 1;
						// imageData[ i ] = Math.floor( factor * imageData[ i ]);
						// imageData[ i + 1 ] = Math.floor( factor * imageData[ i + 1]);
						// imageData[ i + 2 ] = Math.floor( factor * imageData[ i + 2 ]);
						
						// Multiply ** (best!!!)
						imageData[ i ] = Math.floor( factor * imageData[ i ]);
						imageData[ i + 1 ] = Math.floor( factor * imageData[ i + 1]);
						imageData[ i + 2 ] = Math.floor( factor * imageData[ i + 2 ]);
						
						// Divide
						// imageData[ i ] = Math.floor( imageData[ i ] / factor);
						// imageData[ i + 1 ] = Math.floor( imageData[ i + 1] / factor);
						// imageData[ i + 2 ] = Math.floor( imageData[ i + 2 ] / factor);
						
						// Additive
						// imageData[ i ] += n ;
						// imageData[ i + 1 ] += n;
						// imageData[ i + 2 ] += n;
						
						// Subtractive
						// imageData[ i ] -= n ;
						// imageData[ i + 1 ] -= n;
						// imageData[ i + 2 ] -= n;

						// Reverse subtractive
						// imageData[ i ] = n - imageData[ i ] ;
						// imageData[ i + 1 ] = n - imageData[ i + 1 ];
						// imageData[ i + 2 ] = n - imageData[ i + 2 ];
						
						// Blend
						// imageData[ i ] = (n + imageData[ i ]) /2 ;
						// imageData[ i + 1 ] = (n + imageData[ i + 1 ]) /2;
						// imageData[ i + 2 ] = (n + imageData[ i + 2 ]) /2;
						
						// Noise only
						// imageData[ i ] = n;
						// imageData[ i + 1 ] = n;
						// imageData[ i + 2 ] = n;

											
						// imageData[ i + 3 ] = 255;					
					
						// imageData[ i ] = 255;
						// imageData[ i + 1 ] = 255;
						// imageData[ i + 2 ] = 255;
						// imageData[ i + 3 ] = n;
					
			
					}
					context.putImageData( image, 0, 0 );
					
					console.log('done', Date.now() - now);

				}
				
				this.redraw();
				
				return this;
			}
			
			var canvas = createCloudTexture(800, 600)
			animate();

	
			function animate() {

				requestAnimationFrame( animate );
				render();

			}

			function render() {
				canvas.redraw();
			}

		</script>
	</body>
</html>
