<html>
<head>
	<title>Text Sand 1</title>
</head>
<body>
	<div id="container" style="display:block; z-index:50;"></div>
	<p>Description: we are trying to create sand particles to form the shape of text.</p>
	<p>This approach uses randomness over entire canvas, and eliminating all fall off sand.</p>
	<p>Randomness - a interesting topic in itself (link intel), but gives possibilities, lots of them really.</p>
	<p>Using the desired properties of being uniformly distributed...</p>
	<p id="2">2pm -> 10:30am</p>
		 
	<script>
	
	var text = "你好!"; //"Hello Sand! :)";
	var font = "bold 50pt Arial"; //bold 
	var particleCount = 5000; //100000
	var scale = 5;
	
	var particles = [];

	// TODO fine tune stuff.
	// small text, higher tunning. big text, more resources
	var container = document.getElementById('container');
	
	
	//view-source:http://www.html5rocks.com/en/tutorials/canvas/texteffects/Text-Effects.html#neon+rainbow+jitter
	
	//TODO: Do this correctly!!!
	// calculate TextBounds needed.
	// var div  = document.createElement('span');
	// div.font = font;
	// div.textContent = text;
	// 
	// var emHeight = div.offsetHeight;
	// console.log("emHeight", emHeight);
	
	var width, height = 200;
	
	// create canvas
	var canvas = document.createElement("canvas");
	
	var context = canvas.getContext('2d');

	// textAlign textBaseline
	context.fillStyle = 'black';
	context.font = font;
	
	width = context.measureText(text).width;
	width = Math.ceil(width);

	canvas.width = width;
	canvas.height = height;
	canvas.style.width = width;
	canvas.style.height = height;
	
	context.font = font;
	
	//http://www.html5rocks.com/en/tutorials/canvas/texteffects/
	//!!! http://stackoverflow.com/questions/1134586/how-can-you-find-the-height-of-text-on-an-html-canvas
	context.textBaseline = "top";
	// context.shadowColor = "#eef";
	// context.shadowOffsetX = 5;
	// context.shadowOffsetY = 5;
	// context.shadowBlur = blur;
	
	context.fillText(text, 0, 0);
	
	console.log('width, height', width, height);
	document.body.appendChild(canvas);
	
	
	var image = context.getImageData( 0, 0, width, height );
	var data = image.data; //Uint8ClampedArray
	
	console.log('data length', data.length);
	
	
	var textArea = [];
	
	for (i=3, il= data.length;i <il;i+=4) {
		hit = (data[i] > 0);
		if (hit) {
			
			index = Math.floor(i / 4);
			x = index % width;
			y = Math.floor(index / width);
			
			textArea.push({x:x, y:y});
		}
	}
	
	var x,y, index, hit, testX, testY;
	start = Date.now();
	
	//console.log('textarea', textArea);
	
	
	var orginalCanvas = canvasElement();
	
	// Take a different approach
	for (var i=0; i<particleCount; i++) {
		index = Math.floor(Math.random() * textArea.length);
		coods = textArea[index];
		x = coods.x + Math.random() - 0.5;
		y = coods.y + Math.random() - 0.5;

			
		var e = createParticleElement(x*scale, y* scale);
		//e.move(x*scale, y* scale);
		particles.push(e);
		
	}
	
	alert('lapse' +( Date.now() - start) );
	console.log('particles hitted', particles.length, particles.length*100/particleCount);
	
	
	function canvasElement() {
		var elm = document.createElement('canvas');
		//elm.style.border = '1px solid rgb('+Math.random()*100+'%,'+Math.random()*100+'%,'+Math.random()*100+'%)';

		var size = 10;

		elm.style.position = 'absolute';
		elm.style.width = elm.style.height = size+'px';
		//elm.style['-webkit-transform'] = 'translateZ(0)';
		elm.width = elm.height= size;
		
		var ctx = elm.getContext("2d");

		var alpha = 1;
		ctx.fillStyle = 'rgba(0, 0, 0,'+alpha+')'; 

		var r = size/3;
		ctx.arc(size/2,size/2,r,0,Math.PI*2, true);

		ctx.fill();
		
		return elm;
	}
	

	
	function createParticleElement(x,y) {
		// clone element, copy image - chrome 1800 - opera 1300
		// create element , fill - chrome 2600 opera 2300 
		// create element , draw image - chrome 2400 opera 2200 
		
		// 	    var elm = document.createElement('canvas');
		// 	    var ctx = elm.getContext('2d');
		// 
		// var size = 10;
		// 
		// elm.style.position = 'absolute';
		// elm.style.width = elm.style.height = size+'px';
		// elm.width = elm.height= size;
		// 	    
		var elm = orginalCanvas.cloneNode(false); //true
		var ctx = elm.getContext('2d');
		
		
		// var alpha = 1;
		// ctx.fillStyle = 'rgba(0, 0, 0,'+alpha+')'; 
		// 
		// var r = size/3;
		// ctx.arc(size/2,size/2,r,0,Math.PI*2, true);
		// 
		// ctx.fill();
		
		var _x = x, _y = y;
		
		//apply the old canvas to the new one
	    ctx.drawImage(orginalCanvas, 0, 0, 10, 10);

	    //return the new canvas
		//document.body.appendChild(elm);
		container.appendChild(elm);
		
		var move = function() {
			elm.style.left = _x;
			elm.style.top = _y;
			
			//console.log(x,y);
		}
		
		move();

		return {
			e: elm,
			move: move, 
			update: function() {
				_x += (Math.random()-0.5) * 5;
				_y += (Math.random()-0.5) * 5;
				
				move(_x, _y);
				
			}
		};

	}
	
	if ( !window.requestAnimationFrame ) {

		window.requestAnimationFrame = ( function() {

			return window.webkitRequestAnimationFrame ||
			window.mozRequestAnimationFrame ||
			window.oRequestAnimationFrame ||
			window.msRequestAnimationFrame ||
			function( /* function FrameRequestCallback */ callback, /* DOMElement Element */ element ) {

				window.setTimeout( callback, 1000 / 60 );

			};

		} )();

	}
	
	function render() {
		//console.log('r');
		particles.forEach(function(a,b) {
			a.update();
		});
		
	}
	
	function rendering() {
		requestAnimationFrame(rendering);
		
		render();
		
	}
	
	requestAnimationFrame(rendering);

	//this.e.style["-webkit-transform"] = "translate3d(" +  x + "px," + y + "px, 0)";
	//e.style["-webkit-transform"] = "translate3d(" +  5 + "px," + 5 + "px, 0)";
	//e.style["transform"] = "translateZtranslate3d(" +  5 + "px," + 5 + "px, 0)";
	//e.style["-moz-transform"] = "translateZtranslate3d(" +  200 + "px," + 50 + "px, 0px)";
	//e.style["-moz-transform-origin"]  = "0 0;"
	//e.style["-moz-transform"] =  "translate(" +  100 + "px,  " + Math.floor(200) + "px)";
	
	</script>
	
</body>
</html>